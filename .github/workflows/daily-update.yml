name: Daily Data Update

on:
  schedule:
    - cron: '0 20 * * *' # 05:00 KST (20:00 UTC previous day)
    - cron: '0 3 * * *'  # 12:00 KST (03:00 UTC)
  workflow_dispatch:
  push:
    branches:
      - main # Manual trigger

permissions:
  contents: write # Needed to push changes

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Chrome
        id: setup-chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install dependencies
        run: |
          export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
          npm ci

      - name: Install System Dependencies (Puppeteer)
        run: |
          sudo apt-get update
          sudo apt-get install -y libgbm-dev libnss3 libatk-bridge2.0-0 libx11-xcb1 libxcb-dri3-0 libxcomposite1 libxcursor1 libxdamage1 libxi6 libxtst6 libnss3 libcups2 libxss1 libxrandr2 libasound2t64 libpangocairo-1.0-0 libatk1.0-0 libgtk-3-0

      - name: Run Scrapers
        env:
          PUPPETEER_EXECUTABLE_PATH: ${{ steps.setup-chrome.outputs.chrome-path }}
        run: |
          npx tsx scripts/scrape-kovo.ts
          npx tsx scripts/scrape-kbl.ts
          npx tsx scripts/scrape-festival.ts
          npx tsx scripts/scrape-yes24.ts
          npx tsx scripts/scrape-timeticket.ts
          npx tsx scripts/scrape-travel.ts

      - name: Commit and Push changes
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add src/data/*.json
          # Only commit if there are changes
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update sports data" && git push)

      - name: Build Website
        run: npm run build

      - name: FTP Deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./out/
          server-dir: ./html/culture/ # Based on user URL http://pyw31337.dothome.co.kr/culture/
