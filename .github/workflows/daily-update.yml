name: Daily Data Update

on:
  schedule:
    - cron: '0 20 * * *' # 05:00 KST (20:00 UTC previous day)
    - cron: '0 3 * * *'  # 12:00 KST (03:00 UTC)
  workflow_dispatch:
  push:
    branches:
      - main # Manual trigger

permissions:
  contents: write # Needed to push changes
  actions: read   # Needed to check previous run status

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Chrome
        id: setup-chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install dependencies
        run: |
          export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
          npm ci

      - name: Install System Dependencies (Puppeteer)
        run: |
          sudo apt-get update
          sudo apt-get install -y libgbm-dev libnss3 libatk-bridge2.0-0 libx11-xcb1 libxcb-dri3-0 libxcomposite1 libxcursor1 libxdamage1 libxi6 libxtst6 libnss3 libcups2 libxss1 libxrandr2 libasound2t64 libpangocairo-1.0-0 libatk1.0-0 libgtk-3-0

      - name: Check Retry Condition (Skip if 12:00 PM and prev run success)
        id: check_retry
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          current_hour=$(date -u +%H)
          # 03 UTC is 12 KST.
          if [ "$current_hour" -eq "03" ]; then
            echo "Time is 12:00 PM KST (03:00 UTC). Checking if previous run succeeded..."
            # Get status of the last COMPLETED run for this workflow
            last_status=$(gh run list --workflow daily-update.yml --status completed --limit 1 --json conclusion --jq '.[0].conclusion')
            echo "Last run status: $last_status"
            
            if [ "$last_status" == "success" ]; then
              echo "Previous run was successful. Skipping this retry execution."
              echo "SKIP_EXECUTION=true" >> $GITHUB_ENV
            else
              echo "Previous run failed or unknown ($last_status). Proceeding with retry."
              echo "SKIP_EXECUTION=false" >> $GITHUB_ENV
            fi
          else
            echo "Regular schedule. Proceeding."
            echo "SKIP_EXECUTION=false" >> $GITHUB_ENV
          fi

      - name: Run Scrapers
        if: (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && env.SKIP_EXECUTION != 'true'
        env:
          PUPPETEER_EXECUTABLE_PATH: ${{ steps.setup-chrome.outputs.chrome-path }}
        run: |
          node scripts/scrape-interpark-standalone.js || true
          npx tsx scripts/scrape-kovo.ts || true
          npx tsx scripts/scrape-kbl.ts || true
          npx tsx scripts/scrape-festival.ts || true
          npx tsx scripts/scrape-yes24.ts || true
          npx tsx scripts/scrape-timeticket.ts || true
          npx tsx scripts/scrape-travel.ts || true
          node scripts/scrape-movies.js || true
          node scripts/scrape-myrealtrip.js || true
          node scripts/scrape-klook.js || true
          npx tsx scripts/scrape-umclass.ts || true
          npx tsx scripts/scrape-mochaclass.ts || true
          npx tsx scripts/build-venues.ts || true

      - name: Commit and Push changes
        if: env.SKIP_EXECUTION != 'true'
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add src/data/*.json
          # Only commit if there are changes
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update sports data" && git push)

      - name: Build Website
        if: env.SKIP_EXECUTION != 'true'
        run: npm run build

      - name: Deploy to GitHub Pages
        if: env.SKIP_EXECUTION != 'true'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out

      - name: Prepare Redirect for Dothome
        if: env.SKIP_EXECUTION != 'true'
        run: |
          # Clear the output directory
          rm -rf out/*
          # Create Redirect File
          cat <<EOF > out/index.html
          <!DOCTYPE html>
          <html lang="ko">
          <head>
          <meta charset="UTF-8">
          <meta http-equiv="refresh" content="0; url=https://pyw31337.github.io/culture/">
          <script>window.location.href = "https://pyw31337.github.io/culture/";</script>
          <title>Redirecting...</title>
          </head>
          <body>
          <p>사이트가 이전되었습니다. <a href="https://pyw31337.github.io/culture/">https://pyw31337.github.io/culture/</a>로 이동합니다.</p>
          </body>
          </html>
          EOF

      - name: Deploy Redirect to Dothome (FTP)
        if: env.SKIP_EXECUTION != 'true'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./out/
          server-dir: ./html/culture/ # Based on user URL http://pyw31337.dothome.co.kr/culture/
